name: CI-CD Pipeline

on:
  push:
    branches:
      - main
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # Checkout code
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------------------------------------
      # Set up Java (your project is Java + Spring Boot)
      # -------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # -------------------------------------------------------
      # Build Spring Boot jar
      # -------------------------------------------------------
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # -------------------------------------------------------
      # Log in to Docker Hub
      # -------------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # -------------------------------------------------------
      # Build & Push Docker image
      # -------------------------------------------------------
      - name: Build and Push Image
        run: |
          docker build -t rajuray143/myappdemo:latest .
          docker push rajuray143/myappdemo:latest

      # -------------------------------------------------------
      # Create kubeconfig from secret (FIXED COMMANDS HERE)
      # -------------------------------------------------------
      - name: deployment
        run: |
          kubectl apply -f .k8s/myapp1-deployment.yaml
           
