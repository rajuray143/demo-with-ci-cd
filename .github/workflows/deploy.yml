name: CI-CD Pipeline

on:
  push:
    branches:
      - main
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # Checkout code
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------------------------------------
      # Set up Java (your project is Java + Spring Boot)
      # -------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # -------------------------------------------------------
      # Build Spring Boot jar
      # -------------------------------------------------------
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # -------------------------------------------------------
      # Log in to Docker Hub
      # -------------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # -------------------------------------------------------
      # Build & Push Docker image
      # -------------------------------------------------------
      - name: Build and Push Image
        run: |
          docker build -t rajuray143/myappdemo:latest .
          docker push rajuray143/myappdemo:latest

      # -------------------------------------------------------
      # Create kubeconfig from secret (FIXED COMMANDS HERE)
      # -------------------------------------------------------
      - name: Create kubeconfig file
        run: |
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | tr -d '\r' | base64 --decode > kubeconfig.yaml
          # NOTE: The 'export KUBECONFIG' line here only works in this specific step's shell session.
          # We explicitly use the --kubeconfig flag below for clarity and consistency.
          kubectl --kubeconfig=kubeconfig.yaml get nodes

      # -------------------------------------------------------
      # Test connection (Already correct, explicitly uses the file)
      # -------------------------------------------------------
      - name: Test Kubernetes Connection
        run: |
          kubectl --kubeconfig=kubeconfig.yaml get nodes

      # -------------------------------------------------------
      # Update deployment image automatically (Already correct, explicitly uses the file)
      # -------------------------------------------------------
      - name: Deploy to Kubernetes
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|rajuray143/myappdemo:latest|g" k8s/myapp1-deployment.yaml
          kubectl --kubeconfig=kubeconfig.yaml apply -f k8s/myapp1-deployment.yaml




